<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WASM Demo</title>
  <style>
    * {
      user-select: none;
      -webkit-user-select: none;
    }

    body {
      margin: 0;
      background: #111;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    canvas {
      /* upscale without blurring */
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      /* optional: make it bigger on screen */
      width: 960px;
      height: 600px;
    }
    .instructions {
      position: absolute;
      top: 12px;
      left: 12px;
      color: #eee;
      font: 14px/1.2 system-ui, sans-serif;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px 8px;
      border-radius: 6px;
    }
    .controls {
      position: absolute;
      bottom: 16px;
      left: 16px;
      display: grid;
      grid-template-columns: 56px 56px 56px;
      grid-template-rows: 56px 56px 56px;
      gap: 8px;
      user-select: none;
      touch-action: none;
    }
    .controls button {
      width: 56px;
      height: 56px;
      border: 0;
      border-radius: 10px;
      background: rgba(34, 34, 34, 0.9);
      color: #eee;
      font: 20px/1 system-ui, sans-serif;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    .controls .empty {
      background: transparent;
      pointer-events: none;
    }
    .actions {
      position: absolute;
      bottom: 16px;
      right: 16px;
      display: grid;
      grid-template-columns: 56px 56px;
      gap: 8px;
      user-select: none;
      touch-action: none;
    }
    .actions button {
      width: 56px;
      height: 56px;
      border: 0;
      border-radius: 10px;
      background: rgba(34, 34, 34, 0.9);
      color: #eee;
      font: 24px/1 system-ui, sans-serif;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    .rotate-overlay {
      position: fixed;
      inset: 0;
      background: #111;
      color: #eee;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      font: 18px/1.4 system-ui, sans-serif;
      z-index: 10;
      padding: 24px;
    }
    @media (orientation: portrait) {
      .rotate-overlay {
        display: flex;
      }
      .instructions,
      canvas,
      .controls,
      .actions {
        display: none;
      }
    }
  </style>
</head>
<body>

  <!-- MUST match your C WIDTH/HEIGHT -->
  <div class="instructions">arrows - to move; +/- to increase the square</div>
  <canvas id="game" width="320" height="200"></canvas>
  <div class="rotate-overlay">Rotate your device to landscape to play.</div>
  <div class="controls" aria-label="movement controls">
    <button class="empty" aria-hidden="true"></button>
    <button data-key="ArrowUp" aria-label="move up">▲</button>
    <button class="empty" aria-hidden="true"></button>
    <button data-key="ArrowLeft" aria-label="move left">◀</button>
    <button class="empty" aria-hidden="true"></button>
    <button data-key="ArrowRight" aria-label="move right">▶</button>
    <button class="empty" aria-hidden="true"></button>
    <button data-key="ArrowDown" aria-label="move down">▼</button>
    <button class="empty" aria-hidden="true"></button>
  </div>
  <div class="actions" aria-label="size controls">
    <button data-action="grow" aria-label="grow">+</button>
    <button data-action="shrink" aria-label="shrink">−</button>
  </div>

  <script>
    // Define Module BEFORE loading demo.js
    var Module = {
      onRuntimeInitialized() {
        start();
      }
    };

    function start() {
      console.log("WASM ready");

      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d", { alpha: false });

      // MUST match canvas width/height
      const W = canvas.width;
      const H = canvas.height;

      const img = ctx.createImageData(W, H);

      const gameStep = Module.cwrap("game_step", null, ["number"]);
      const getFB    = Module.cwrap("get_framebuffer", "number");
      const setColor = Module.cwrap("set_color", null, ["number", "number", "number", "number"]);
      const growRect = Module.cwrap("grow_rect", null, []);
      const shrinkRect = Module.cwrap("shrink_rect", null, []);
      const moveRect = Module.cwrap("move_rect", null, ["number", "number"]);

      let last = performance.now();
      const keys = new Set();

      function loop(now) {
        // Clamp dt so tab-switch doesn't explode your movement
        let dt = (now - last) / 1000.0;
        last = now;
        if (dt > 0.05) dt = 0.05;

        const step = 120 * dt;
        if (keys.has("ArrowLeft")) moveRect(-step, 0);
        if (keys.has("ArrowRight")) moveRect(step, 0);
        if (keys.has("ArrowUp")) moveRect(0, -step);
        if (keys.has("ArrowDown")) moveRect(0, step);

        gameStep(dt);

      const ptr = getFB();
      const heap = Module.HEAPU8 || HEAPU8;
      const pixels = new Uint8ClampedArray(
        heap.buffer,
        ptr,
        img.data.length
      );

        img.data.set(pixels);
        ctx.putImageData(img, 0, 0);

        requestAnimationFrame(loop);
      }

      setColor(255, 0, 255, 255);

      function bindHoldButton(button, code) {
        const onDown = (e) => {
          e.preventDefault();
          keys.add(code);
        };
        const onUp = (e) => {
          e.preventDefault();
          keys.delete(code);
        };
        button.addEventListener("pointerdown", onDown);
        button.addEventListener("pointerup", onUp);
        button.addEventListener("pointerleave", onUp);
        button.addEventListener("pointercancel", onUp);
      }

      function bindActionButton(button, action) {
        let repeatTimeout = null;
        let repeatInterval = null;
        const fire = () => {
          if (action === "grow") growRect();
          if (action === "shrink") shrinkRect();
        };
        const clearTimers = () => {
          if (repeatTimeout) {
            clearTimeout(repeatTimeout);
            repeatTimeout = null;
          }
          if (repeatInterval) {
            clearInterval(repeatInterval);
            repeatInterval = null;
          }
        };
        const onDown = (e) => {
          e.preventDefault();
          fire();
          clearTimers();
          repeatTimeout = setTimeout(() => {
            fire();
            repeatInterval = setInterval(fire, 80);
          }, 250);
        };
        const onUp = (e) => {
          e.preventDefault();
          clearTimers();
        };
        button.addEventListener("pointerdown", onDown);
        button.addEventListener("pointerup", onUp);
        button.addEventListener("pointerleave", onUp);
        button.addEventListener("pointercancel", onUp);
      }

      document.querySelectorAll("[data-key]").forEach((btn) => {
        bindHoldButton(btn, btn.getAttribute("data-key"));
      });
      document.querySelectorAll("[data-action]").forEach((btn) => {
        bindActionButton(btn, btn.getAttribute("data-action"));
      });

      document.addEventListener("keydown", (e) => {
        if (e.code === "Equal") {
          e.preventDefault();
          growRect();
          return;
        }
        if (e.code === "Minus") {
          e.preventDefault();
          shrinkRect();
          return;
        }
        if (e.code.startsWith("Arrow")) {
          e.preventDefault();
          keys.add(e.code);
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.code.startsWith("Arrow")) {
          e.preventDefault();
          keys.delete(e.code);
        }
      });

      requestAnimationFrame(loop);
    }
  </script>

  <!-- Emscripten output -->
  <script src="demo.js"></script>

</body>
</html>
